<!-- Modal mô tả sản phẩm -->
<% products.forEach(product=> { %> <div
        class="productModalBg modal-bg hidden fixed inset-0 w-screen h-screen bg-black/30 z-[999] flex justify-center items-center "
        data-id="<%= product._id %>" data-name="<%= product.name %>" data-price="<%= product.price %>"
        data-image="/images/product/<%= product.images[0] %>" data-description="<%= product.description %>">
        <div style="width: min-content;margin:40px 0 -40px 0;padding-top: 60px;padding-bottom: 60px;"
            class=" productModal bg-white rounded-[12px] max-w-[400px] w-[90%] px-6 py-8 shadow-[0_4px_24px_#eee] relative ">
            <img src="" alt="" class="modalImg w-[350px] object-cover rounded-[8px] block" style="height: 400px;">
            <div class="flex justify-between" style="align-items: center;">

                <h3 class="modalTitle" style=" color:var(--primary-color);"></h3>
                <span class="modalPrice" style="color:var(--primary-color); font-weight:bold; font-size:1.1rem;"></span>
            </div>
            <p class="modalDesc" style="color:#888; margin:-12px 0;"></p>
            <div id="sizeWarning"
                style="display:none;color:#e91e63;font-size:0.98rem;margin-top:8px;text-align:center;margin-top: 15px">
                サイズを選択してください！</div>
            <div class="flex justify-between" style="margin-top:16px;">
                <!-- Chọn size -->
                <div>
                    <div class="flex gap-3 flex-wrap">
                        <% product.sizes.forEach(size=> { %> <button
                                class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-[color-mix(in srgb,var(--primary-color)_20%,white)] hover:border-[var(--primary-color)] focus:ring-2 focus:ring-[var(--primary-color)] transition cursor-pointer">
                                <%= size %>
                            </button>
                            <% }) %>
                    </div>
                </div>
                <!-- Chọn số lượng -->
                <div>
                    <div class="flex items-center border rounded-lg w-36 overflow-hidden" style="width: fit-content;">
                        <button type="button"
                            class="px-3 py-2 text-lg font-bold text-gray-600 hover:bg-gray-100 dec cursor-pointer">-</button>
                        <input type="number" value="1" min="1" style="height: -webkit-fill-available;"
                            class="quantity w-full text-center border-x focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
                        <button type="button"
                            class="px-3 py-2 text-lg font-bold text-gray-600 hover:bg-gray-100 inc cursor-pointer">+</button>
                    </div>
                </div>
            </div> <button class="modalAddToCart btn"
                style="margin-top:18px; width:100%; background:var(--primary-color); color:#fff; border-radius:8px; padding:10px 0; font-size:1rem;">
                カートに追加</button>
        </div>
    </div>
    <% }) %>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Hàm ẩn tất cả modal
                function hideAllModals() {
                    document.querySelectorAll('.modal-bg').forEach(m => {
                        m.classList.add('hidden');
                        m.style.display = 'none';
                    });
                }

                // --- Modal ---
                const productBtns = document.querySelectorAll('.product-btn');
                const modalBgs = document.querySelectorAll('.modal-bg');

                // Gắn listener đóng modal cho mỗi modal
                modalBgs.forEach(modalBg => {
                    modalBg.addEventListener('click', function (e) {
                        if (e.target === modalBg) {
                            hideAllModals();
                        }
                    });
                });

                // Mở modal khi click sản phẩm
                productBtns.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        hideAllModals(); // Ẩn tất cả modal trước khi hiển thị modal mới

                        const productId = btn.dataset.id;
                        const modalBg = document.querySelector(`.modal-bg[data-id="${productId}"]`);
                        if (!modalBg) return;

                        // Cập nhật dữ liệu modal
                        const modalImg = modalBg.querySelector('.modalImg');
                        const modalTitle = modalBg.querySelector('.modalTitle');
                        const modalPrice = modalBg.querySelector('.modalPrice');
                        const modalDesc = modalBg.querySelector('.modalDesc');

                        modalImg.src = modalBg.dataset.image;
                        modalImg.alt = modalBg.dataset.name;
                        modalTitle.textContent = modalBg.dataset.name;
                        modalPrice.textContent = Number(modalBg.dataset.price).toLocaleString() + '¥';
                        modalDesc.textContent = modalBg.dataset.description;

                        // Hiển thị modal
                        modalBg.classList.remove('hidden');
                        modalBg.style.display = 'flex';

                        // --- Size ---
                        let selectedSize = null;
                        const sizeButtons = modalBg.querySelectorAll('.flex.gap-3.flex-wrap button');
                        sizeButtons.forEach(btn => {
                            btn.classList.remove('bg-[var(--primary-color)]', 'text-white', 'border-[var(--primary-color)]');
                            btn.addEventListener('click', function () {
                                sizeButtons.forEach(b => b.classList.remove('bg-[var(--primary-color)]', 'text-white', 'border-[var(--primary-color)]'));
                                btn.classList.add('bg-[var(--primary-color)]', 'text-white', 'border-[var(--primary-color)]');
                                selectedSize = btn.textContent.trim();
                            });
                        });

                        // --- Quantity ---
                        const decBtn = modalBg.querySelector('.dec');
                        const incBtn = modalBg.querySelector('.inc');
                        const quantityInput = modalBg.querySelector('.quantity');
                        decBtn.addEventListener('click', () => {
                            let val = parseInt(quantityInput.value);
                            if (val > 1) quantityInput.value = val - 1;
                        });
                        incBtn.addEventListener('click', () => {
                            let val = parseInt(quantityInput.value);
                            quantityInput.value = val + 1;
                        });

                        // --- Add to cart ---
                        const addToCartBtn = modalBg.querySelector('.modalAddToCart');
                        addToCartBtn.onclick = function () {
                            const quantity = parseInt(quantityInput.value);
                            const size = selectedSize;
                            const image = modalBg.dataset.image;
                            const sizeWarning = modalBg.querySelector('#sizeWarning');
                            if (!size) {
                                sizeWarning.style.display = 'block';
                                setTimeout(() => { sizeWarning.style.display = 'none'; }, 2000);
                                return;
                            }
                            sizeWarning.style.display = 'none';
                            const product = {
                                id: modalBg.dataset.id,
                                name: modalBg.dataset.name,
                                price: Number(modalBg.dataset.price),
                                image: image,
                                size: size,
                                quantity: quantity
                            };
                            addToCart(product);
                            console.log('check product:', product);
                            addToCartBtn.textContent = '追加した！';
                            setTimeout(() => addToCartBtn.textContent = 'カートに追加', 1000);

                            if (typeof updateCartCount === 'function') updateCartCount();
                        };
                    });
                });

            });

        </script>